package jobs;

import indexClasses.TimestampTree;
import io.inputformats.Input1;
import mappers.IndexBuilderMapper;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.conf.Configured;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;
import org.apache.hadoop.util.Tool;
import org.apache.hadoop.util.ToolRunner;

import reducers.IndexBuilderReducer;



public class IndexBuilder extends Configured implements Tool {

	@Override
	public int run(String[] args) throws Exception {
		/*Set configuration*/
		Configuration conf = new Configuration();
		// Set conf variables pointing to the BD4 cluster 
		conf.set("fs.defaultFS", "hdfs://bigdata-06.dcs.gla.ac.uk:8020");
		conf.set("mapred.job.tracker", "bigdata-06.dcs.gla.ac.uk:8021");
		conf.set("mapred.jar", "file:///users/level4/1003264m/DatData/DatData/IndexedQueries/IndexBuilder.jar");

		
		// Delete the output directory to allow the job to run
		// !!! CAUTION !!! Make sure you are not deleting something you need !!! CAUTION !!!
		FileSystem fs = FileSystem.get(conf);
		fs.delete(new Path("/user/1003264m/index/"), true);
		/*initialise Job*/
		
		Job job= new Job(conf);
		job.setJobName("Index Builder");
		job.setJarByClass(IndexBuilder.class);


		/*Set Input and Output*/
		job.setInputFormatClass(Input1.class);
		job.setOutputFormatClass(TextOutputFormat.class);
		job.getConfiguration().set("mapreduce.output.basename", "index.txt");
		
		/*Set classes for mappers/reducers*/
		job.setReducerClass(IndexBuilderReducer.class);

		/*Set output key values */
		job.setMapOutputKeyClass(LongWritable.class);
		job.setMapOutputValueClass(Text.class);
		job.setOutputKeyClass(LongWritable.class);
		job.setOutputValueClass(TimestampTree.class);
		
		FileInputFormat.addInputPath(job, new Path("/user/bd4-project1/enwiki-20080103-sample.txt"));
		FileOutputFormat.setOutputPath(job, new Path("/user/1003264m/index/"));
		

		/*submit job*/
		job.submit();
		return (job.waitForCompletion(true) ? 0 : 1);
	}
	
	public static void main(String[] args) throws Exception {
		 System.exit(ToolRunner.run(new Configuration(), new IndexBuilder(), args));
	}

}
